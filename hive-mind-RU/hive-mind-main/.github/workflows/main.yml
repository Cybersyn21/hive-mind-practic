name: CI/CD Pipeline for main branch

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # === DETECT CHANGES ===
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      mjs-changed: ${{ steps.changes.outputs.mjs }}
      package-changed: ${{ steps.changes.outputs.package }}
      docs-changed: ${{ steps.changes.outputs.docs }}
      workflow-changed: ${{ steps.changes.outputs.workflow }}
      docker-changed: ${{ steps.changes.outputs.docker }}
      any-code-changed: ${{ steps.changes.outputs.code }}
      new-version: ${{ steps.changes.outputs.new-version }}
      version: ${{ steps.changes.outputs.version }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - name: Detect changes and check version
      id: changes
      run: |
        # For PRs, compare against base branch; for pushes, compare with previous commit
        EVENT_NAME="${{ github.event_name }}"
        if [ "$EVENT_NAME" = "pull_request" ]; then
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          git fetch origin $BASE_SHA
          CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA 2>/dev/null || echo "")
        else
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD 2>/dev/null || git ls-tree --name-only -r HEAD)
        fi
        
        echo "Changed files:"
        echo "$CHANGED_FILES"
        
        # Check for .mjs file changes
        if echo "$CHANGED_FILES" | grep -q '\.mjs$'; then
          echo "mjs=true" >> $GITHUB_OUTPUT
        else
          echo "mjs=false" >> $GITHUB_OUTPUT
        fi
        
        # Check for package.json changes
        if echo "$CHANGED_FILES" | grep -q '^package\.json$'; then
          echo "package=true" >> $GITHUB_OUTPUT
        else
          echo "package=false" >> $GITHUB_OUTPUT
        fi
        
        # Check for documentation changes
        if echo "$CHANGED_FILES" | grep -q '\.md$'; then
          echo "docs=true" >> $GITHUB_OUTPUT
        else
          echo "docs=false" >> $GITHUB_OUTPUT
        fi
        
         # Check for workflow changes
         if echo "$CHANGED_FILES" | grep -q '\.github/workflows/'; then
           echo "workflow=true" >> $GITHUB_OUTPUT
         else
           echo "workflow=false" >> $GITHUB_OUTPUT
         fi

         # Check for docker-related changes
         if echo "$CHANGED_FILES" | grep -qE '(^Dockerfile$|^\.dockerignore$|^scripts/ubuntu-24-server-install\.sh$)'; then
           echo "docker=true" >> $GITHUB_OUTPUT
         else
           echo "docker=false" >> $GITHUB_OUTPUT
         fi
        
        # Check for any code changes (.mjs, package.json, or workflows)
        if echo "$CHANGED_FILES" | grep -qE '\.(mjs|json|yml|yaml)$|\.github/workflows/'; then
          echo "code=true" >> $GITHUB_OUTPUT
        else
          echo "code=false" >> $GITHUB_OUTPUT
        fi
        
        # Check version status
        # Only check for new versions on main branch pushes
        if [ "${{ github.ref }}" != "refs/heads/main" ] || [ "${{ github.event_name }}" != "push" ]; then
          echo "Not a main branch push - skipping version check"
          echo "new-version=false" >> $GITHUB_OUTPUT
        else
          if [ ! -f "package.json" ]; then
            echo "new-version=false" >> $GITHUB_OUTPUT
            echo "No package.json found"
          else
            VERSION=$(node -p "require('./package.json').version")
            PACKAGE_NAME=$(node -p "require('./package.json').name")
            
            # Check if version is already published on NPM
            if npm view "$PACKAGE_NAME@$VERSION" version 2>/dev/null; then
              echo "Version $VERSION already published"
              echo "new-version=false" >> $GITHUB_OUTPUT
            else
              echo "New version $VERSION detected - will publish"
              echo "new-version=true" >> $GITHUB_OUTPUT
              echo "version=$VERSION" >> $GITHUB_OUTPUT
            fi
          fi
        fi
        
        # Debug output
        echo "============ Debug Output ============"
        echo "GitHub ref: ${{ github.ref }}"
        echo "Event name: ${{ github.event_name }}"
        echo "All outputs written to GITHUB_OUTPUT:"
        cat $GITHUB_OUTPUT || echo "Could not read GITHUB_OUTPUT"
        echo "======================================"

  # === VERSION BUMP VERIFICATION ===
  verify-version-bump:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout PR branch
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x

    - name: Verify version bump
      run: |
        echo "=== Version Bump Verification ==="

        # Get base and head refs
        BASE_REF="${{ github.event.pull_request.base.ref }}"
        HEAD_REF="${{ github.event.pull_request.head.ref }}"
        BASE_SHA="${{ github.event.pull_request.base.sha }}"
        HEAD_SHA="${{ github.event.pull_request.head.sha }}"

        echo "Base branch: $BASE_REF ($BASE_SHA)"
        echo "Head branch: $HEAD_REF ($HEAD_SHA)"

        # Fetch the base branch
        git fetch origin $BASE_REF:$BASE_REF

        # Get current version from package.json
        if [ ! -f "package.json" ]; then
          echo "‚ùå No package.json found in PR"
          exit 1
        fi

        CURRENT_VERSION=$(node -p "require('./package.json').version")
        echo "Current version in PR: $CURRENT_VERSION"

        # Get base version from package.json
        git checkout $BASE_SHA -- package.json 2>/dev/null || {
          echo "‚ùå Could not get package.json from base branch"
          exit 1
        }

        if [ ! -f "package.json" ]; then
          echo "‚ùå No package.json found in base branch"
          exit 1
        fi

        BASE_VERSION=$(node -p "require('./package.json').version")
        echo "Base version: $BASE_VERSION"

        # Restore current package.json
        git checkout $HEAD_SHA -- package.json

        # Compare versions using semver (Node.js native comparison)
        COMPARISON=$(node -e "
          function compareSemver(a, b) {
            const aParts = a.split('.').map(Number);
            const bParts = b.split('.').map(Number);

            for (let i = 0; i < 3; i++) {
              if (aParts[i] > bParts[i]) return 1;
              if (aParts[i] < bParts[i]) return -1;
            }
            return 0;
          }

          const current = '$CURRENT_VERSION';
          const base = '$BASE_VERSION';
          console.log(compareSemver(current, base));
        ")

        echo "Comparing versions: $CURRENT_VERSION vs $BASE_VERSION (result: $COMPARISON)"

        if [ "$COMPARISON" -le 0 ]; then
          if [ "$COMPARISON" -eq 0 ]; then
            echo "‚ùå Version has not been bumped!"
          else
            echo "‚ùå Version in PR ($CURRENT_VERSION) is LOWER than base version ($BASE_VERSION)!"
          fi
          echo "   Current version in PR: $CURRENT_VERSION"
          echo "   Base version in main: $BASE_VERSION"
          echo ""
          echo "üí° Please bump the version in package.json to be strictly greater than $BASE_VERSION."
          echo "   You can use semantic versioning:"
          echo "   - Patch (bug fixes): npm version patch"
          echo "   - Minor (new features): npm version minor"
          echo "   - Major (breaking changes): npm version major"
          exit 1
        else
          echo "‚úÖ Version has been bumped from $BASE_VERSION to $CURRENT_VERSION"
        fi

  # === COMPILATION & SYNTAX CHECKS ===
  test-compilation:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any-code-changed == 'true' || needs.detect-changes.outputs.workflow-changed == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        
    - name: Test solve.mjs compilation
      run: |
        echo "Testing solve.mjs compilation..."
        timeout 30s node --check src/solve.mjs
        echo "‚úÖ solve.mjs compiles successfully"
        
    - name: Test hive.mjs compilation
      run: |
        echo "Testing hive.mjs compilation..."
        timeout 30s node --check src/hive.mjs
        echo "‚úÖ hive.mjs compiles successfully"
        
    - name: Check Node.js syntax for all .mjs files
      run: |
        echo "Checking syntax for all .mjs files..."
        for file in *.mjs; do
          if [ -f "$file" ]; then
            echo "Checking $file..."
            timeout 10s node --check "$file"
          fi
        done
        for file in src/*.mjs; do
          if [ -f "$file" ]; then
            echo "Checking $file..."
            timeout 10s node --check "$file"
          fi
        done
        for file in tests/*.mjs; do
          if [ -f "$file" ]; then
            echo "Checking $file..."
            node --check "$file"
          fi
        done

  # === ESLINT CODE QUALITY CHECK ===
  lint:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.mjs-changed == 'true' || needs.detect-changes.outputs.workflow-changed == 'true'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x

    - name: Install dependencies
      run: npm ci

    - name: Run ESLint
      run: |
        echo "Running ESLint code quality checks..."
        npm run lint
        echo "‚úÖ ESLint checks passed"

  # === FILE LINE LIMIT CHECK ===
  check-file-line-limits:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.mjs-changed == 'true' || needs.detect-changes.outputs.workflow-changed == 'true'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check .mjs file line limits
      run: |
        echo "Checking that all .mjs files are under 1500 lines..."

        # Create a temporary file to track failures
        FAILURES_FILE=$(mktemp)

        # Check all .mjs files in the repository
        find . -name "*.mjs" -type f | while read -r file; do
          line_count=$(wc -l < "$file")
          echo "üìÑ $file: $line_count lines"

          if [ $line_count -gt 1500 ]; then
            echo "‚ùå ERROR: $file has $line_count lines, which exceeds the 1500 line limit!"
            echo "::error file=$file::File has $line_count lines (limit: 1500)"
            echo "$file" >> "$FAILURES_FILE"
          else
            echo "‚úÖ $file is within the 1500 line limit"
          fi
        done

        # Check if any failures occurred
        if [ -s "$FAILURES_FILE" ]; then
          echo ""
          echo "‚ùå The following .mjs files exceed the 1500 line limit:"
          cat "$FAILURES_FILE"
          echo ""
          echo "Please reorganize the code to split large files into smaller modules."
          echo "Each .mjs file should have no more than 1500 lines of code."
          rm -f "$FAILURES_FILE"
          exit 1
        else
          echo ""
          echo "‚úÖ All .mjs files are within the 1500 line limit!"
          rm -f "$FAILURES_FILE"
        fi

  # === UNIT TESTS ===
  test-suites:
    runs-on: ubuntu-latest
    needs: [detect-changes, test-compilation]
    if: needs.detect-changes.outputs.any-code-changed == 'true' || needs.detect-changes.outputs.workflow-changed == 'true'

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x

    - name: Install dependencies
      run: npm install

    - name: Run test suite for solve.mjs
      run: |
        echo "Running test suite for solve.mjs..."
        node tests/test-solve.mjs
    
    - name: Run test suite for hive.mjs
      run: |
        echo "Running test suite for hive.mjs..."
        node tests/test-hive.mjs
    
    - name: Run test suite for memory-check.mjs
      run: |
        echo "Running test suite for memory-check.mjs..."
        node tests/test-memory-check.mjs

    - name: Run branch name validation test (Issue #647)
      run: |
        echo "Running test suite for branch name validation..."
        node tests/test-branch-name-validation.mjs

    - name: Run feedback lines regression test (Issue #168)
      run: |
        echo "Running feedback lines regression test..."
        node tests/test-feedback-lines-simple.mjs

    - name: Run feedback lines integration test (Issue #168)
      env:
        GITHUB_TOKEN: ${{ secrets.TEST_GITHUB_USER_TOKEN || secrets.GITHUB_TOKEN }}
        TEST_GITHUB_USERNAME: ${{ secrets.TEST_GITHUB_USERNAME }}
        TEST_GITHUB_USER_TOKEN: ${{ secrets.TEST_GITHUB_USER_TOKEN }}
      run: |
        echo "Running feedback lines integration test with real repository..."
        node tests/test-feedback-lines-integration.mjs

    - name: Run Sentry integration test
      run: |
        echo "Running test suite for Sentry integration..."
        node tests/test-sentry.mjs

    - name: Run telegram-bot dry-run test (Issue #487)
      run: |
        echo "Running test suite for telegram-bot --dry-run mode..."
        node tests/test-telegram-bot-dry-run.mjs

    - name: Run telegram-bot hero Links Notation test (Issue #623)
      run: |
        echo "Running test suite for telegram-bot hero example with Links Notation..."
        node tests/test-telegram-bot-hero-links-notation.mjs

    - name: Run hive command silent failure test (Issue #504)
      run: |
        echo "Running test suite for hive command silent failures..."
        node tests/test-hive-no-silent-failure.mjs

    - name: Run GitHub linking keyword detection test (Issue #568)
      run: |
        echo "Running test suite for GitHub linking keyword detection..."
        node tests/test-github-linking.mjs

    - name: Run Telegram Markdown escaping test (Issue #580)
      run: |
        echo "Running test suite for Telegram Markdown escaping..."
        node tests/test-telegram-markdown-escaping.mjs

    - name: Run lenv-reader test (Issue #604)
      run: |
        echo "Running test suite for lenv-reader.lib.mjs..."
        node tests/test-lenv-reader.mjs

    - name: Run Telegram URL extraction test (Issue #603)
      run: |
        echo "Running test suite for Telegram URL extraction..."
        node tests/test-telegram-url-extraction.mjs

    - name: Run Telegram URL validation test (Issue #630)
      run: |
        echo "Running test suite for Telegram URL validation..."
        node tests/test-telegram-validate-url.mjs

    - name: Run interactive mode test (Issue #800)
      run: |
        echo "Running test suite for interactive mode..."
        node tests/test-interactive-mode.mjs

    - name: Run start-screen test (Issue #539)
      run: |
        echo "Running test suite for start-screen.mjs..."
        node tests/test-start-screen.mjs

  # === EXECUTION TESTS ===
  test-execution:
    runs-on: ubuntu-latest
    needs: [detect-changes, test-compilation]
    if: needs.detect-changes.outputs.any-code-changed == 'true' || needs.detect-changes.outputs.workflow-changed == 'true'

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x

    - name: Install dependencies
      run: npm install

    - name: Test solve.mjs execution
      run: |
        echo "Testing solve.mjs basic execution..."
        timeout 10s ./src/solve.mjs --help || echo "Help command completed"
        echo "‚úÖ solve.mjs executes without critical errors"
        timeout 10s ./src/solve.mjs --version || true

    - name: Verify log files contain version and command (Issue #517)
      run: |
        echo "Testing that log files contain version and command at the start..."
        # Run solve with dry-run and capture log file location
        timeout 30s ./src/solve.mjs "https://github.com/test/repo/issues/1" --dry-run --skip-tool-check 2>&1 | tee test-log-output.txt || true

        # Extract log file path from output (pattern includes T for timestamp format)
        LOG_FILE=$(grep -o "solve-[0-9T-]*Z\.log" test-log-output.txt | head -1)

        if [ -z "$LOG_FILE" ]; then
          echo "‚ö†Ô∏è  Could not find log file path in output"
          cat test-log-output.txt
          exit 1
        fi

        echo "Log file: $LOG_FILE"

        if [ ! -f "$LOG_FILE" ]; then
          echo "‚ùå Log file not found: $LOG_FILE"
          ls -la solve-*.log || echo "No solve log files found"
          exit 1
        fi

        echo ""
        echo "Checking log file contents..."
        head -30 "$LOG_FILE"

        echo ""
        echo "Verifying version appears in log..."
        if grep -q "üöÄ solve v" "$LOG_FILE"; then
          echo "‚úÖ Version found in log file"
        else
          echo "‚ùå Version NOT found in log file"
          exit 1
        fi

        echo ""
        echo "Verifying command appears in log..."
        if grep -q "üîß Raw command executed:" "$LOG_FILE"; then
          echo "‚úÖ Command found in log file"
        else
          echo "‚ùå Command NOT found in log file"
          exit 1
        fi

        echo ""
        echo "‚úÖ Log file verification passed - version and command are present"

    - name: Test hive.mjs execution
      run: |
        echo "Testing hive.mjs basic execution..."
        timeout 10s ./src/hive.mjs --help || echo "Help command completed"
        echo "‚úÖ hive.mjs executes without critical errors"
        timeout 10s ./src/hive.mjs --version || true

    - name: Test telegram-bot.mjs execution
      run: |
        echo "Testing telegram-bot.mjs basic execution..."
        timeout 10s ./src/telegram-bot.mjs --help || echo "Help command completed"
        echo "‚úÖ telegram-bot.mjs executes without critical errors"

        echo ""
        echo "Testing telegram-bot.mjs --dry-run with issue #487 command..."
        timeout 10s ./src/telegram-bot.mjs \
          --token "test_token_123" \
          --allowed-chats "(-1002975819706 -1002861722681)" \
          --no-hive \
          --solve-overrides $'( \n  --auto-continue\n  --attach-logs\n  --verbose\n  --no-tool-check\n)' \
          --dry-run
        echo "‚úÖ Issue #487 command passes with --dry-run"
    
    - name: Test memory-check.mjs execution
      run: |
        ./src/memory-check.mjs --help
        ./src/memory-check.mjs --min-memory 10 --min-disk-space 100 --json

    - name: Test global command installation
      run: |
        echo "Testing npm global command installation from local folder..."
        npm link
        echo "‚úÖ npm link completed successfully"

        echo ""
        echo "Testing 'hive' global command..."
        timeout 10s hive --version || true
        timeout 10s hive --help || echo "Help command completed"
        echo "‚úÖ 'hive' global command works"

        echo ""
        echo "Testing 'solve' global command..."
        timeout 10s solve --version || true
        timeout 10s solve --help || echo "Help command completed"
        echo "‚úÖ 'solve' global command works"

        echo ""
        echo "Testing 'hive-telegram-bot' global command..."
        timeout 10s hive-telegram-bot --help || echo "Help command completed"
        echo "‚úÖ 'hive-telegram-bot' global command works"

        echo ""
        echo "Testing hive-telegram-bot --dry-run (issue #487)..."
        # Note: 30s timeout needed for first-time module loading via unpkg.com CDN
        # The telegraf module can take several seconds to load on cold start
        timeout 30s hive-telegram-bot \
          --token "test_token" \
          --allowed-chats "(-1 -2)" \
          --no-hive \
          --solve-overrides "(--auto-continue --verbose)" \
          --dry-run
        echo "‚úÖ 'hive-telegram-bot --dry-run' works"

        echo ""
        echo "Cleaning up global link..."
        npm unlink || true

    - name: Test hive dry-run with solve integration
      run: |
        echo "Testing hive dry-run mode with solve command integration..."
        # Test that hive passes --dry-run and --skip-claude-check to solve
        timeout 30s ./src/hive.mjs https://github.com/test/repo --dry-run --skip-claude-check --once --max-issues 1 2>&1 | tee hive_dry_run.log || true

        # Check that the solve command was called with the correct flags
        if grep -q "solve.*--dry-run.*--skip-claude-check" hive_dry_run.log; then
          echo "‚úÖ hive correctly passes --dry-run and --skip-claude-check flags to solve command"
        else
          echo "‚ö†Ô∏è Could not verify flag propagation in dry-run mode (may be due to no issues found)"
        fi

        # Test solve.mjs directly with dry-run and skip-claude-check
        echo ""
        echo "Testing solve.mjs with --dry-run and --skip-claude-check flags..."
        timeout 10s ./src/solve.mjs https://github.com/test/repo/issues/1 --dry-run --skip-claude-check 2>&1 | head -20 || true
        echo "‚úÖ solve.mjs accepts --dry-run and --skip-claude-check flags"

    - name: Test --auto-fork option
      run: |
        echo "Testing --auto-fork option with dry-run mode..."

        # Test solve with --auto-fork
        echo ""
        echo "Testing solve.mjs with --auto-fork and --dry-run..."
        timeout 10s ./src/solve.mjs https://github.com/test/repo/issues/1 --auto-fork --dry-run --skip-tool-check 2>&1 | tee solve_auto_fork.log || true
        if grep -qE "(auto-fork|Auto-fork)" solve_auto_fork.log; then
          echo "‚úÖ solve.mjs recognizes --auto-fork flag"
        else
          echo "‚ö†Ô∏è Could not verify --auto-fork flag in solve output"
        fi

        # Test hive with --auto-fork
        echo ""
        echo "Testing hive.mjs with --auto-fork and --dry-run..."
        timeout 30s ./src/hive.mjs https://github.com/test/repo --auto-fork --dry-run --skip-tool-check --once --max-issues 1 2>&1 | tee hive_auto_fork.log || true
        if grep -qE "(auto-fork|Auto-fork)" hive_auto_fork.log; then
          echo "‚úÖ hive.mjs recognizes --auto-fork flag"
        else
          echo "‚ö†Ô∏è Could not verify --auto-fork flag in hive output"
        fi

        # Test start-screen with --auto-fork (just verify it accepts the flag)
        echo ""
        echo "Testing start-screen.mjs passes --auto-fork to solve..."
        # start-screen requires screen to be installed, so we just test flag parsing
        timeout 5s ./src/start-screen.mjs solve https://github.com/test/repo/issues/1 --auto-fork 2>&1 | tee start_screen_auto_fork.log || true
        # If screen is not installed, that's okay - we just want to verify the flag is accepted
        if grep -qE "(auto-fork|GNU Screen|screen.*not.*installed)" start_screen_auto_fork.log; then
          echo "‚úÖ start-screen.mjs accepts --auto-fork flag"
        else
          echo "‚ö†Ô∏è Could not verify start-screen flag acceptance"
        fi

        echo ""
        echo "‚úÖ All --auto-fork option tests completed"

  # === MEMORY CHECKS - LINUX ===
  memory-check-linux:
    runs-on: ubuntu-latest
    needs: [detect-changes, test-compilation]
    if: needs.detect-changes.outputs.any-code-changed == 'true' || needs.detect-changes.outputs.workflow-changed == 'true'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
    
    - name: System info
      run: |
        echo "=== System Information ==="
        uname -a
        echo ""
        echo "=== Memory Information ==="
        free -h
        echo ""
        echo "=== Disk Information ==="
        df -h
        echo ""
        echo "=== CPU Information ==="
        lscpu | head -20
    
    - name: Run memory-check tests
      run: |
        chmod +x tests/test-memory-check.mjs
        node tests/test-memory-check.mjs
    
    - name: Test memory-check with various thresholds
      run: |
        echo "Testing with low thresholds (should pass)..."
        ./src/memory-check.mjs --min-memory 10 --min-disk-space 100 --json
        
        echo ""
        echo "Testing verbose output..."
        ./src/memory-check.mjs --min-memory 10 --min-disk-space 100
        
        echo ""
        echo "Testing quiet mode..."
        ./src/memory-check.mjs --min-memory 10 --min-disk-space 100 --quiet --json
    
    - name: Test memory-check failure conditions
      run: |
        echo "Testing with impossible memory requirement (should fail)..."
        if ./src/memory-check.mjs --min-memory 999999 --exit-on-failure --quiet --json; then
          echo "ERROR: Should have failed with impossible memory requirement"
          exit 1
        else
          echo "‚úÖ Correctly failed with impossible memory requirement"
        fi
        
        echo ""
        echo "Testing with impossible disk requirement (should fail)..."
        if ./src/memory-check.mjs --min-disk-space 999999999 --exit-on-failure --quiet --json; then
          echo "ERROR: Should have failed with impossible disk requirement"
          exit 1
        else
          echo "‚úÖ Correctly failed with impossible disk requirement"
        fi

  # === MEMORY CHECKS - MACOS ===
  # Temporarily disabled - can be re-enabled later
  memory-check-macos:
    runs-on: macos-latest
    needs: [detect-changes, test-compilation]
    if: false
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
    
    - name: System info
      run: |
        echo "=== System Information ==="
        uname -a
        echo ""
        echo "=== Memory Information ==="
        vm_stat
        echo ""
        echo "=== Disk Information ==="
        df -h
        echo ""
        echo "=== Swap Information ==="
        sysctl vm.swapusage
        echo ""
        echo "=== CPU Information ==="
        sysctl -n machdep.cpu.brand_string
        sysctl hw.ncpu
    
    - name: Run memory-check tests
      run: |
        chmod +x tests/test-memory-check.mjs
        node tests/test-memory-check.mjs
    
    - name: Test memory-check with various thresholds
      run: |
        echo "Testing with low thresholds (should pass)..."
        ./src/memory-check.mjs --min-memory 10 --min-disk-space 100 --json
        
        echo ""
        echo "Testing verbose output..."
        ./src/memory-check.mjs --min-memory 10 --min-disk-space 100
        
        echo ""
        echo "Testing quiet mode..."
        ./src/memory-check.mjs --min-memory 10 --min-disk-space 100 --quiet --json
    
    - name: Test memory-check failure conditions
      run: |
        echo "Testing with impossible memory requirement (should fail)..."
        if ./src/memory-check.mjs --min-memory 999999 --exit-on-failure --quiet --json; then
          echo "ERROR: Should have failed with impossible memory requirement"
          exit 1
        else
          echo "‚úÖ Correctly failed with impossible memory requirement"
        fi
        
        echo ""
        echo "Testing with impossible disk requirement (should fail)..."
        if ./src/memory-check.mjs --min-disk-space 999999999 --exit-on-failure --quiet --json; then
          echo "ERROR: Should have failed with impossible disk requirement"
          exit 1
        else
          echo "‚úÖ Correctly failed with impossible disk requirement"
        fi
    
    - name: Test macOS-specific features
      run: |
        echo "Testing macOS swap detection..."
        output=$(./src/memory-check.mjs --min-memory 10 --quiet --json)
        if echo "$output" | grep -q '"swap"'; then
          echo "‚úÖ Swap information detected in output"
        else
          echo "‚ö†Ô∏è  Warning: Swap information not found in output"
        fi

  # === MEMORY CHECKS - WINDOWS ===
  # Temporarily disabled due to use-m bug on Windows: https://github.com/link-foundation/use-m/issues/45
  # The Windows support code is implemented but use-m fails to load on Windows
  memory-check-windows:
    runs-on: windows-latest
    needs: [detect-changes, test-compilation]
    # DISABLED: use-m doesn't work on Windows - see use-m-issues/issue-04-windows-fetch-undefined.mjs
    if: false
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
    
    - name: System info
      shell: cmd
      run: |
        echo === System Information ===
        systeminfo | findstr /C:"OS Name" /C:"OS Version" /C:"System Type"
        echo.
        echo === Memory Information ===
        REM wmic is deprecated in Windows Server 2025, use PowerShell instead
        powershell -Command "Get-CimInstance Win32_OperatingSystem | Select-Object TotalVisibleMemorySize, FreePhysicalMemory | Format-List"
        echo.
        echo === Disk Information ===
        powershell -Command "Get-CimInstance Win32_LogicalDisk | Select-Object Caption, Size, FreeSpace | Format-Table"
    
    - name: Test memory-check execution
      shell: bash
      run: |
        echo "Node version: $(node --version)"
        echo "Testing memory-check.mjs on Windows..."
        node ./src/memory-check.mjs --min-memory 10 --min-disk-space 100
        
        echo ""
        echo "Testing with JSON output..."
        node ./src/memory-check.mjs --min-memory 10 --min-disk-space 100 --json

  # === DOCUMENTATION VALIDATION ===
  validate-docs:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.docs-changed == 'true'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
    
    - name: Validate documentation files
      run: |
        echo "Running documentation validation tests..."
        chmod +x tests/docs-validation.mjs
        node tests/docs-validation.mjs

  # === PUBLISH TO NPM ===
  publish:
    if: always()
    runs-on: ubuntu-latest
    needs: [detect-changes, test-compilation, test-suites, test-execution, memory-check-linux, validate-docs]
    permissions:
      contents: write  # Required for creating releases
      packages: write  # Required for publishing packages

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        registry-url: 'https://registry.npmjs.org'

    - name: Publish
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        if [ "${{ needs.detect-changes.outputs.new-version }}" != "true" ]; then
          echo "‚äò Publishing skipped (no new version detected)"
          echo "  new-version output: ${{ needs.detect-changes.outputs.new-version }}"
          exit 0
        fi

        echo "‚úì New version detected, proceeding with publish"

        # Make scripts executable
        chmod +x src/hive.mjs
        chmod +x src/solve.mjs

        # Publish to NPM
        npm publish --access public

        # Create GitHub Release
        VERSION=${{ needs.detect-changes.outputs.version }}
        PACKAGE_NAME=$(node -p "require('./package.json').name")
        gh release create "v${VERSION}" \
          --title "${VERSION}" \
          --notes "$(cat <<EOF
        Release ${VERSION}

        NPM: https://www.npmjs.com/package/${PACKAGE_NAME}/v/${VERSION}

        Docker: https://hub.docker.com/r/konard/hive-mind/tags?name=${VERSION}

        Helm chart attached as asset
        EOF
        )"

    - name: Upload Source Maps to Sentry
      if: needs.detect-changes.outputs.new-version == 'true'
      env:
        SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
      run: |
        echo "üì§ Uploading source maps to Sentry for version ${{ needs.detect-changes.outputs.version }}"
        chmod +x scripts/upload-sourcemaps.mjs
        node scripts/upload-sourcemaps.mjs

  # === DOCKER BUILD AND PUBLISH ===
  docker-publish:
    if: always()
    runs-on: ubuntu-latest
    needs: [detect-changes, publish]
    permissions:
      contents: read
      packages: write

    env:
      REGISTRY: docker.io
      IMAGE_NAME: konard/hive-mind

    steps:
      - name: Check if Docker publish should run
        id: should-run
        run: |
          if [ "${{ needs.detect-changes.outputs.new-version }}" != "true" ]; then
            echo "‚äò Docker publish skipped (no new version detected)"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "‚úì New version detected, proceeding with Docker publish"
          echo "should_run=true" >> $GITHUB_OUTPUT

      - name: Wait for NPM package availability
        if: steps.should-run.outputs.should_run == 'true'
        run: |
          VERSION="${{ needs.detect-changes.outputs.version }}"
          PACKAGE_NAME="@deep-assistant/hive-mind"
          MAX_ATTEMPTS=30
          SLEEP_TIME=10

          echo "‚è≥ Waiting for NPM package ${PACKAGE_NAME}@${VERSION} to become available..."

          for i in $(seq 1 $MAX_ATTEMPTS); do
            echo "Attempt $i/$MAX_ATTEMPTS: Checking NPM registry..."

            if npm view "${PACKAGE_NAME}@${VERSION}" version 2>/dev/null; then
              echo "‚úÖ Package ${PACKAGE_NAME}@${VERSION} is now available on NPM!"
              exit 0
            fi

            if [ $i -lt $MAX_ATTEMPTS ]; then
              echo "Package not yet available, waiting ${SLEEP_TIME} seconds..."
              sleep $SLEEP_TIME
            fi
          done

          echo "‚ùå Package ${PACKAGE_NAME}@${VERSION} did not become available after $((MAX_ATTEMPTS * SLEEP_TIME)) seconds"
          exit 1

      - name: Checkout repository
        if: steps.should-run.outputs.should_run == 'true'
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        if: steps.should-run.outputs.should_run == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: steps.should-run.outputs.should_run == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        if: steps.should-run.outputs.should_run == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ needs.detect-changes.outputs.version }}
            type=raw,value=latest

      - name: Build and push Docker image
        if: steps.should-run.outputs.should_run == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Verify published image
        if: steps.should-run.outputs.should_run == 'true'
        run: |
          echo "‚úÖ Docker image published successfully"
          echo "Image: ${{ env.IMAGE_NAME }}"
          echo "Tags: ${{ steps.meta.outputs.tags }}"
          echo ""
          echo "To pull and use this image:"
          echo "  docker pull ${{ env.IMAGE_NAME }}:${{ needs.detect-changes.outputs.version }}"
          echo "  docker pull ${{ env.IMAGE_NAME }}:latest"
          echo "  docker run -it ${{ env.IMAGE_NAME }}:latest"

  # === DOCKER PR CHECK ===
  docker-pr-check:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: github.event_name == 'pull_request' && (needs.detect-changes.outputs.docker-changed == 'true' || needs.detect-changes.outputs.workflow-changed == 'true')

    env:
      REGISTRY: docker.io
      IMAGE_NAME: konard/hive-mind

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image with log capture
        run: |
          echo "üî® Building Docker image with log capture..."
          # Build with plain progress output to capture full logs
          # This is the ONLY build - we use --load to make it available for docker run
          docker build --progress=plain -t ${{ env.IMAGE_NAME }}:test . 2>&1 | tee build-output.log

          echo ""
          echo "‚úÖ Docker image built successfully"
          docker images | grep -E "${{ env.IMAGE_NAME }}|REPOSITORY"

      - name: Verify Homebrew and PHP in build logs
        run: |
          echo "üìä Checking installation status in build logs..."

          # Check for the specific "not found" errors that indicate failure
          if grep -E '\[!\] Homebrew: not found' build-output.log; then
            echo "‚ùå ERROR: Homebrew installation failed - showing as 'not found'"
            exit 1
          fi

          if grep -E '\[!\] PHP: not found' build-output.log; then
            echo "‚ùå ERROR: PHP installation failed - showing as 'not found'"
            exit 1
          fi

          # Check for success indicators
          if grep -E '\[‚úì\] Homebrew:' build-output.log; then
            echo "‚úÖ Homebrew installation verified in build logs"
          else
            echo "‚ö†Ô∏è  WARNING: Homebrew success message not found in logs"
          fi

          if grep -E '\[‚úì\] PHP:' build-output.log; then
            echo "‚úÖ PHP installation verified in build logs"
          else
            echo "‚ö†Ô∏è  WARNING: PHP success message not found in logs (may appear as 'installed but not in current PATH' during build)"
          fi

      - name: Verify tools in running container
        run: |
          echo "üîç Verifying tools are available in the running container..."

          docker run --rm ${{ env.IMAGE_NAME }}:test bash -c "
            echo 'Checking Homebrew...'
            if command -v brew &>/dev/null; then
              brew --version | head -n1
              echo '‚úÖ Homebrew is accessible'
            else
              echo '‚ùå Homebrew command not found in container'
              exit 1
            fi

            echo ''
            echo 'Checking PHP...'
            if command -v php &>/dev/null; then
              php --version | head -n1
              echo '‚úÖ PHP is accessible'
            else
              # Check if PHP binary exists but is not in PATH
              if [ -x /home/linuxbrew/.linuxbrew/opt/php@8.3/bin/php ]; then
                /home/linuxbrew/.linuxbrew/opt/php@8.3/bin/php --version | head -n1
                echo '‚ö†Ô∏è  PHP is installed but not in PATH (may need shell restart)'
              else
                echo '‚ùå PHP not found in container'
                exit 1
              fi
            fi
          "

          echo ""
          echo "‚úÖ All verification checks passed!"

  # === HELM PR CHECK ===
  helm-pr-check:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Get package version
        id: package-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Package version: $VERSION"

      - name: Lint Helm chart
        run: |
          echo "Linting Helm chart..."
          helm lint helm/hive-mind
          echo "‚úÖ Helm chart validation passed"

      - name: Verify Chart.yaml structure
        run: |
          echo "Verifying Chart.yaml structure..."
          if [ ! -f "helm/hive-mind/Chart.yaml" ]; then
            echo "‚ùå Chart.yaml not found"
            exit 1
          fi

          # Check for required fields
          if ! grep -q "^name:" helm/hive-mind/Chart.yaml; then
            echo "‚ùå Chart name not found"
            exit 1
          fi

          if ! grep -q "^version:" helm/hive-mind/Chart.yaml; then
            echo "‚ùå Chart version not found"
            exit 1
          fi

          if ! grep -q "^appVersion:" helm/hive-mind/Chart.yaml; then
            echo "‚ùå Chart appVersion not found"
            exit 1
          fi

          echo "‚úÖ Chart.yaml structure is valid"

  # === HELM CHART RELEASE ===
  helm-release:
    if: always()
    runs-on: ubuntu-latest
    needs: [detect-changes, docker-publish]
    permissions:
      contents: write
      packages: write
      pages: write
      id-token: write

    steps:
      - name: Check if Helm release should run
        id: should-run
        run: |
          if [ "${{ needs.detect-changes.outputs.new-version }}" != "true" ]; then
            echo "‚äò Helm release skipped (no new version detected)"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "‚úì New version detected, proceeding with Helm release"
          echo "should_run=true" >> $GITHUB_OUTPUT

      - name: Checkout repository
        if: steps.should-run.outputs.should_run == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        if: steps.should-run.outputs.should_run == 'true'
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        if: steps.should-run.outputs.should_run == 'true'
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Update Chart versions
        if: steps.should-run.outputs.should_run == 'true'
        id: chart-version
        run: |
          APP_VERSION="${{ needs.detect-changes.outputs.version }}"

          # Update appVersion to match package.json version
          sed -i "s/^appVersion: .*/appVersion: \"$APP_VERSION\"/" helm/hive-mind/Chart.yaml
          echo "Updated Chart.yaml appVersion to $APP_VERSION"

          # Sync chart version with app version for consistency
          # This ensures a new release is created when appVersion changes
          sed -i "s/^version: .*/version: $APP_VERSION/" helm/hive-mind/Chart.yaml
          echo "Updated Chart.yaml version to $APP_VERSION"

          echo "chart_version=$APP_VERSION" >> $GITHUB_OUTPUT

          # Show the updated Chart.yaml
          echo "=== Updated Chart.yaml ==="
          cat helm/hive-mind/Chart.yaml

      - name: Lint Helm chart
        if: steps.should-run.outputs.should_run == 'true'
        run: |
          helm lint helm/hive-mind

      - name: Package Helm chart
        if: steps.should-run.outputs.should_run == 'true'
        run: |
          echo "Packaging Helm chart..."
          mkdir -p .helm-packages
          helm package helm/hive-mind -d .helm-packages
          echo "Chart packaged successfully:"
          ls -la .helm-packages/

      - name: Ensure gh-pages branch exists
        if: steps.should-run.outputs.should_run == 'true'
        run: |
          # Check if gh-pages branch exists on remote
          if ! git ls-remote --exit-code --heads origin gh-pages >/dev/null 2>&1; then
            echo "gh-pages branch does not exist. Creating it..."

            # Create an orphan branch (no history)
            git checkout --orphan gh-pages

            # Remove all files from staging
            git reset --hard

            # Create initial commit
            git commit --allow-empty -m "Initialize gh-pages branch for Helm charts"

            # Push the new branch to remote
            git push origin gh-pages

            # Switch back to the original branch
            git checkout -

            echo "gh-pages branch created successfully"
          else
            echo "gh-pages branch already exists"
          fi

      - name: Checkout gh-pages branch
        if: steps.should-run.outputs.should_run == 'true'
        run: |
          # Fetch gh-pages branch
          git fetch origin gh-pages:gh-pages
          git checkout gh-pages

      - name: Update Helm repository index
        if: steps.should-run.outputs.should_run == 'true'
        run: |
          # Copy packaged chart to gh-pages
          cp .helm-packages/*.tgz .

          # Update or create index.yaml
          helm repo index . --url https://link-assistant.github.io/hive-mind

          echo "Updated index.yaml:"
          cat index.yaml

      - name: Commit and push to gh-pages
        if: steps.should-run.outputs.should_run == 'true'
        run: |
          git add -f *.tgz index.yaml
          git commit -m "Release Helm chart version ${{ needs.detect-changes.outputs.version }}" || echo "No changes to commit"
          git push origin gh-pages

      - name: Switch back to main branch
        if: steps.should-run.outputs.should_run == 'true'
        run: |
          git checkout -

      - name: Upload chart to release
        if: steps.should-run.outputs.should_run == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.detect-changes.outputs.version }}
          files: .helm-packages/*.tgz

      - name: Summary
        if: steps.should-run.outputs.should_run == 'true'
        run: |
          echo "‚úÖ Helm chart released successfully"
          echo "Chart released to GitHub Pages"
          echo "ArtifactHub will automatically discover it at:"
          echo "https://link-assistant.github.io/hive-mind"
          echo ""
          echo "To add to ArtifactHub manually:"
          echo "1. Go to https://artifacthub.io"
          echo "2. Add repository: https://link-assistant.github.io/hive-mind"
          echo "3. Set organization: link-assistant"
          echo "4. Set name: hive-mind"