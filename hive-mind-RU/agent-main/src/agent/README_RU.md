# Каталог agent/ — Ядро AI-агента

## Описание

Каталог `agent/` содержит центральную логику AI-агента — обработку запросов, взаимодействие с AI-моделями и координацию выполнения инструментов.

## Файлы

### agent.ts

**Назначение**: Основной модуль агента, реализующий цикл "запрос-ответ".

**Функциональность**:
- Инициализация агента с заданными параметрами
- Отправка сообщений пользователя в AI-модель
- Обработка ответов модели (текст, вызовы инструментов)
- Координация выполнения инструментов
- Генерация потоковых JSON-событий

**Как работает**:
1. Получает сообщение пользователя (текст или JSON)
2. Формирует контекст с системным промптом
3. Отправляет запрос к провайдеру AI-модели
4. Получает потоковый ответ
5. При получении вызова инструмента — выполняет его
6. Возвращает результат пользователю

### generate.txt

**Назначение**: Текстовый шаблон или конфигурация для генерации ответов.

## Архитектура взаимодействия

```
┌──────────────────────────────────────────────────────────┐
│                       Пользователь                        │
│                  (stdin: JSON или текст)                  │
└──────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────┐
│                       agent.ts                            │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 1. Парсинг входных данных                           │ │
│  │ 2. Формирование системного промпта                  │ │
│  │ 3. Создание сессии                                  │ │
│  │ 4. Отправка запроса к AI-модели                     │ │
│  │ 5. Обработка потокового ответа                      │ │
│  │ 6. Выполнение инструментов при необходимости        │ │
│  │ 7. Вывод результатов                                │ │
│  └─────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────┘
                    │                      │
          ┌─────────┘                      └─────────┐
          ▼                                          ▼
┌────────────────────┐                    ┌────────────────────┐
│   Provider API     │                    │      Tools         │
│  (Grok, GPT и др.) │                    │ (bash, read, etc.) │
└────────────────────┘                    └────────────────────┘
```

## Типы событий

Агент генерирует следующие типы JSON-событий:

| Событие | Описание |
|---------|----------|
| `step_start` | Начало шага обработки |
| `text` | Текстовый ответ от AI |
| `tool_use` | Вызов инструмента |
| `step_finish` | Завершение шага |
| `error` | Ошибка выполнения |

## Пример вывода

```json
{
  "type": "step_start",
  "timestamp": 1763618628840,
  "sessionID": "ses_560236487ffe3ROK1ThWvPwTEF",
  "part": {
    "id": "prt_a9fdca4e8001APEs6AriJx67me",
    "type": "step-start"
  }
}
{
  "type": "text",
  "timestamp": 1763618629886,
  "sessionID": "ses_560236487ffe3ROK1ThWvPwTEF",
  "part": {
    "type": "text",
    "text": "Привет! Чем могу помочь?"
  }
}
```

## Зависимости

- `session/` — управление сессиями и историей
- `provider/` — коммуникация с AI-моделями
- `tool/` — выполнение инструментов
- `format/` — форматирование вывода
