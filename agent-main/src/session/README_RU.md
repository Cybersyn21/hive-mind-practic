# Каталог session/ — Управление сессиями

## Описание

Каталог `session/` отвечает за управление сессиями взаимодействия с AI, включая историю сообщений, системные промпты и обработку состояния.

## Основные файлы

### index.ts
**Назначение**: Главная точка входа модуля сессий.
- Экспорт всех публичных функций и типов
- Инициализация сессии

### agent.js
**Назначение**: Интеграция сессии с агентом.
- Связь между сессией и логикой агента
- Управление жизненным циклом сессии

### message.ts
**Назначение**: Работа с сообщениями.
- Типы сообщений (пользователь, ассистент, система)
- Сериализация и десериализация
- Добавление в историю

### message-v2.ts
**Назначение**: Улучшенная версия работы с сообщениями.
- Расширенные типы сообщений
- Поддержка мультимодальности

### prompt.ts
**Назначение**: Формирование промптов.
- Сборка системного промпта
- Динамическое добавление контекста

### processor.ts
**Назначение**: Обработка входящих данных.
- Парсинг JSON и текста
- Валидация формата

### system.ts
**Назначение**: Системные сообщения и настройки.
- Базовый системный промпт
- Правила поведения агента

### status.ts
**Назначение**: Статус сессии.
- Текущее состояние (активна, завершена, ошибка)
- Метрики использования

### todo.ts
**Назначение**: Интеграция с инструментом todo.
- Управление списком задач внутри сессии
- Синхронизация состояния

### retry.ts
**Назначение**: Логика повторных попыток.
- Обработка ошибок API
- Автоматические повторные запросы

### revert.ts
**Назначение**: Откат изменений.
- Возврат к предыдущему состоянию
- Отмена действий

### summary.ts
**Назначение**: Суммаризация сессии.
- Сжатие длинной истории
- Извлечение ключевой информации

### compaction.ts
**Назначение**: Компактификация истории.
- Оптимизация использования токенов
- Удаление устаревших сообщений

## Каталог prompt/

Содержит текстовые файлы с системными промптами для разных AI-моделей и режимов работы.

| Файл | Описание |
|------|----------|
| `anthropic.txt` | Промпт для моделей Anthropic (Claude) |
| `anthropic-20250930.txt` | Обновлённый промпт Anthropic |
| `anthropic_spoof.txt` | Альтернативный промпт Anthropic |
| `beast.txt` | Агрессивный режим работы |
| `build-switch.txt` | Режим переключения сборки |
| `codex.txt` | Промпт для режима Codex |
| `copilot-gpt-5.txt` | Промпт в стиле Copilot/GPT-5 |
| `gemini.txt` | Промпт для Google Gemini |
| `grok-code.txt` | Промпт для Grok Code |
| `plan.txt` | Режим планирования |
| `polaris.txt` | Промпт Polaris |
| `qwen.txt` | Промпт для Qwen |
| `summarize.txt` | Промпт для суммаризации |
| `summarize-turn.txt` | Суммаризация отдельного хода |
| `title.txt` | Генерация заголовков |

## Жизненный цикл сессии

```
┌─────────────────────────────────────────────────────────────┐
│                    СОЗДАНИЕ СЕССИИ                          │
│  • Генерация уникального ID (ULID)                         │
│  • Загрузка системного промпта                             │
│  • Инициализация истории сообщений                         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    АКТИВНАЯ СЕССИЯ                          │
│  • Приём сообщений пользователя                            │
│  • Отправка запросов к AI                                  │
│  • Выполнение инструментов                                 │
│  • Обновление истории                                      │
└─────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┼───────────────┐
              ▼               ▼               ▼
┌───────────────────┐ ┌───────────────┐ ┌───────────────────┐
│    КОМПАКТИФИКАЦИЯ│ │   СУММАРИЗАЦИЯ│ │    ЗАВЕРШЕНИЕ     │
│ (при переполнении)│ │  (при запросе) │ │ (stop / ошибка)  │
└───────────────────┘ └───────────────┘ └───────────────────┘
```

## Пример использования

```typescript
import { createSession } from './session';

const session = createSession({
  systemPrompt: 'Ты полезный ассистент',
  model: 'opencode/grok-code'
});

await session.addMessage({
  role: 'user',
  content: 'Привет!'
});

const response = await session.generate();
```
